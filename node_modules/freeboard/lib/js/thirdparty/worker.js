var ws;
var ports = [];

function start() {
	if (typeof ws === 'undefined') {
		ws = new WebSocket("ws://192.168.1.80:80");
		ws.onopen = function () {
			for(var i=0; i<ports.length; i++){
				ports[i].postMessage("onconnect:onopen websocket");
			}
		};
		ws.onmessage = function (evt) {
			for(var i=0; i<ports.length; i++){
				ports[i].postMessage("data:"+evt.data);
			}
		};
	}
}

onconnect = function (e) {
	start();
	var port = e.ports[0];

	ports.push(port);

	port.onmessage = function (e) {
		port.postMessage("debug:received message");
		json_obj = e.data;
		if(ws.readyState === WebSocket.OPEN){
		    var json_string = JSON.stringify(json_obj);
		    ws.send(json_string+'\n');
		}
		
	};
}