// ┌────────────────────────────────────────────────────────────────────┐ \\
// │ freeboard-bool-property-RW-plugin AWS                              │ \\
// ├────────────────────────────────────────────────────────────────────┤ \\
// │ The Alexa and Arduino Smart Home Challenge                         │ \\
// | (URL here)                                                         | \\
// ├────────────────────────────────────────────────────────────────────┤ \\
// │ Licensed under the MIT license.                                    │ \\
// ├────────────────────────────────────────────────────────────────────┤ \\
// │ Freeboard widget plugin.                                           │ \\
// └────────────────────────────────────────────────────────────────────┘ \\
(function () {
    //
    // DECLARATIONS
    //
    var LOADING_INDICATOR_DELAY = 1000;

    //

    freeboard.loadWidgetPlugin({
        type_name: "bool_rw_property",
        display_name: "Boolean Property Control",
        description: "Boolean property which can send a value as well as receive",
        settings: [
            {
                name: "title",
                display_name: "Title",
                type: "text"
            },
            {
                name: "config_data",
                display_name: "Configuration Data",
                type: "calculated"
            },
            {
                name: "property",
                display_name: "Property Name",
                type: "text"
            },
            {
                name: "on_value",
                display_name: "On Value",
                type: "text"
            },
            {
                name: "off_value",
                display_name: "Off Value",
                type: "text"
            },            
            {
                name: "ds_name",
                display_name: "Datasource Name",
                type: "text"
            },            
            {
                name: "topicName",
                display_name: "Topic name",
                type: "text"
            },
            {
                name: "on_text",
                display_name: "On Text",
                type: "calculated"
            },
            {
                name: "off_text",
                display_name: "Off Text",
                type: "calculated"
            }

        ],
        newInstance: function (settings, newInstanceCallback) {
            newInstanceCallback(new bool_rw_property(settings));
        }
    });

    freeboard.addStyle('.indicator-light.interactive:hover', "box-shadow: 0px 0px 15px #FF9900; cursor: pointer;");
    var bool_rw_property = function (settings) {
        var self = this;
        var titleElement = $('<h2 class="section-title"></h2>');
        var stateElement = $('<div class="indicator-text"></div>');
        var indicatorElement = $('<div class="indicator-light interactive"></div>');
        var currentSettings = settings;
        var isOn;
        var setValue = false;
        var jsonobj;
        var onText;
        var offText;
        var url;
        var myWorker;
        var updateShadow = false;

        if (!!window.SharedWorker) {
            console.log('Create New Shared Worker - bool property');
            myWorker = new SharedWorker("lib/js/thirdparty/worker.js");

            myWorker.port.onmessage = function(e) {
                var cmd = e.data.split(":");
                switch (cmd[0]){
                    case "debug":
                        console.log(cmd[1]);
                    break;
                    case "data":
                        var data = String(e.data);
                        var response = data.substring('data:'.length);
                        console.log("bool response: "+response);
                        var json_obj = JSON.parse(response);
                        console.log(json_obj);
                        var reported = json_obj["reported"];
                        console.log(reported);
                        isOn = reported["state"];
                        updateState();
                        if(updateShadow){
                            updateThingShadow();
                        }
                    break;
                }
            }
        }
        
        function setOnProperty(property){
            var json_obj = new Object();
            var set_property = json_obj["direct-cmd"] = {};
            set_property.state = property;
            if(property === "on"){
                console.log("setOnProperty: On");

            }else if(property === "off"){
                console.log("setOnProperty: Off");
            }
            set_property.notify = property;
            console.log(json_obj);
            myWorker.port.postMessage(json_obj);
        }

        function updateState() {
            if (isOn === "on") {
                if(setValue === false){
                    setValue = true;
                    updateShadow = true;
                }
                stateElement.text((_.isUndefined(onText) ? (_.isUndefined(currentSettings.on_text) ? "" : currentSettings.on_text) : onText));
                indicatorElement.toggleClass("on", true);
            }
            else if (isOn === "off") {
                if(setValue === true){
                    setValue = false;
                    updateShadow = true;
                }
                stateElement.text((_.isUndefined(offText) ? (_.isUndefined(currentSettings.off_text) ? "" : currentSettings.off_text) : offText));
                indicatorElement.toggleClass("on", false);
            }
        }

        function updateThingShadow() {
            var json_obj = new Object();
            json_obj.state = {};
            var json_reported = json_obj.state.reported = {};
            if(setValue){
                json_reported[currentSettings.property] = currentSettings.off_value;
            }else{
                json_reported[currentSettings.property] = currentSettings.on_value;
            }
            var jsonString= JSON.stringify(json_obj);
            console.log("json: " + jsonString);
            // var datasources = freeboard.getDatasourceSettings("Dehydrator");
            // var datasource = freeboard.getDatasourceInstance("Dehydrator");
            var datasource = freeboard.getDatasourceInstance(currentSettings.ds_name);
            // console.log("datasources settings:");
            // console.log(datasources);
            // console.log("datasources object:");
            // console.log(datasource);
            // console.log("click button received");
            datasource.datasourceInstance.publish(currentSettings.topicName, jsonString);
        }

        this.onClick = function(e) {
            console.log("Button pressed");
            e.preventDefault();

            // var json_obj = new Object();
            // json_obj.state = {};
            // var json_desired = json_obj.state.desired = {};
            // if(setValue){
            //     json_desired[currentSettings.property] = currentSettings.off_value;
            // }else{
            //     json_desired[currentSettings.property] = currentSettings.on_value;
            // }
            // var jsonString= JSON.stringify(json_obj);
            // console.log("json: " + jsonString);
            // // var datasources = freeboard.getDatasourceSettings("Dehydrator");
            // // var datasource = freeboard.getDatasourceInstance("Dehydrator");
            // var datasource = freeboard.getDatasourceInstance(currentSettings.ds_name);
            // // console.log("datasources settings:");
            // // console.log(datasources);
            // // console.log("datasources object:");
            // // console.log(datasource);
            // // console.log("click button received");
            // datasource.datasourceInstance.publish(currentSettings.topicName, jsonString);


            // var new_val = !isOn;
            // jsonobj[currentSettings.property] = new_val;
            // var new_jsondata = JSON.stringify(jsonobj);
            // this.onCalculatedValueChanged('config_data', jsonobj);
            // url = currentSettings.url;
            // if (_.isUndefined(url))
            //     freeboard.showDialog($("<div align='center'>url undefined</div>"), "Error!", "OK", null, function () {
            //     });
            // else {
            //     this.sendValue(url, new_jsondata);
            // }
        }


        this.render = function (element) {
            $(element).append(titleElement).append(indicatorElement).append(stateElement);
            $(indicatorElement).click(this.onClick.bind(this));
        }

        this.onSettingsChanged = function (newSettings) {
            currentSettings = newSettings;
            titleElement.html((_.isUndefined(newSettings.title) ? "" : newSettings.title));
            updateState();
        }

        this.onCalculatedValueChanged = function (settingName, newValue) {
            console.log(settingName);
            console.log(newValue);
            if (settingName == "config_data") {
                var property;
                jsonobj = newValue;
                if(jsonobj.hasOwnProperty("desired")){
                    var desired = jsonobj["desired"];
                    if (desired.hasOwnProperty(currentSettings.property)) {
                        property = desired[currentSettings.property];
                        setOnProperty(property);
                    }   
                }
                if(jsonobj.hasOwnProperty("reported")){
                    if (jsonobj["reported"].hasOwnProperty(currentSettings.property)) {
                        console.log("reported state");
                        console.log(jsonobj[currentSettings.property]);
                    }
                }
            }
            if (settingName == "on_text") {
                onText = newValue;
            }
            if (settingName == "off_text") {
                offText = newValue;
            }
        }

        var request;

        this.sendValue = function (url, json_response) {
            console.log(url, json_response);
            request = new XMLHttpRequest();
            if (!request) {
                console.log('Giving up :( Cannot create an XMLHTTP instance');
                return false;
            }
            request.onreadystatechange = this.alertContents;
            request.open('POST', url, true);
            request.setRequestHeader("Content-type", "application/json");
            freeboard.showLoadingIndicator(true);
            request.send(json_response);
        }

        this.alertContents = function () {
            if (request.readyState === XMLHttpRequest.DONE) {
                if (request.status === 200) {
                    console.log(request.responseText);
                    setTimeout(function () {
                        freeboard.showLoadingIndicator(false);
                        //freeboard.showDialog($("<div align='center'>Request response 200</div>"),"Success!","OK",null,function(){});
                    }, LOADING_INDICATOR_DELAY);
                } else {
                    console.log('There was a problem with the request.');
                    setTimeout(function () {
                        freeboard.showLoadingIndicator(false);
                        freeboard.showDialog($("<div align='center'>There was a problem with the request. Code " + request.status + request.responseText + " </div>"), "Error!", "OK", null, function () {
                        });
                    }, LOADING_INDICATOR_DELAY);
                }

            }

        }

        this.onDispose = function () {
        }

        this.getHeight = function () {
            return 1;
        }

        this.onSettingsChanged(settings);
    };

}());